---
import Container from "../commons/container.astro";
import { Image } from "astro:assets";
import logoWhite from "../../assets/logo-white.svg";
---

<div
   id='menu-overlay'
   class='fixed inset-0 bg-[#212121] translate-x-full transition-transform duration-500 ease-in-out flex items-center z-40 pointer-events-none'
>
   <Container>
      <div style='display: flex; flex-direction: column; gap: clamp(0.5rem, 1vw, 1rem);'>
         <a
            href='#solutions'
            class='menu-item block font-extrabold italic text-white hover:bg-primary hover:text-background transition-colors duration-300 pointer-events-auto'
            style='font-size: clamp(3rem, 8vw, 5rem); padding: clamp(0.5rem, 1vw, 1rem);'
            data-i18n="navbar.menu.home"
         >
            HOME
         </a>
         <a
            href='#solutions'
            class='menu-item block font-extrabold italic text-white hover:bg-primary hover:text-background transition-colors duration-300 pointer-events-auto'
            style='font-size: clamp(3rem, 8vw, 5rem); padding: clamp(0.5rem, 1vw, 1rem);'
            data-i18n="navbar.menu.solutions"
         >
            SOLUTIONS
         </a>
         <a
            href='#lavalab'
            class='menu-item block font-extrabold italic text-white hover:bg-primary hover:text-background transition-colors duration-300 pointer-events-auto'
            style='font-size: clamp(3rem, 8vw, 5rem); padding: clamp(0.5rem, 1vw, 1rem);'
            data-i18n="navbar.menu.lavalab"
         >
            LAVALab
         </a>
         <a
            href='#contact'
            class='menu-item block font-extrabold italic text-white hover:bg-primary hover:text-background transition-colors duration-300 pointer-events-auto'
            style='font-size: clamp(3rem, 8vw, 5rem); padding: clamp(0.5rem, 1vw, 1rem);'
            data-i18n="navbar.menu.contact"
         >
            CONTACT
         </a>
      </div>
   </Container>
</div>

<nav class='w-full fixed top-0 z-50 pointer-events-none' style='padding: clamp(1rem, 2vw, 1.5rem) 0;'>
   <Container>
      <div class='flex justify-between items-center'>
         <div class='relative flex items-center '>
            <!-- Logo (visible cuando el menú está abierto) -->
            <Image
               src={logoWhite}
               class='logo-menu opacity-0 transition-opacity duration-500 pointer-events-none'
               style='width: clamp(8rem, 15vw, 10rem);'
               alt='logo'
            />

            <!-- Botones de idioma (visibles cuando el menú está cerrado) -->
            <div class='language-switcher flex gap-2 opacity-100 transition-opacity duration-500 pointer-events-auto absolute md:top-8 left-0 '>
               <button
                  class='lang-btn w-14 h-14 flex items-center justify-center border rounded-full border-foreground transition-all duration-300 text-sm font-medium pointer-events-auto hover:bg-foreground/5 backdrop-blur-sm'
                  data-lang='en'
                  aria-label='Change language to English'
               >
                  EN
               </button>
               <button
                  class='lang-btn w-14 h-14 flex items-center justify-center border rounded-full border-foreground transition-all duration-300 text-sm font-medium pointer-events-auto hover:bg-foreground/5 backdrop-blur-sm'
                  data-lang='es'
                  aria-label='Change language to Español'
               >
                  ES
               </button>
            </div>
         </div>

         <button
            id='menu-toggle'
            class='relative w-14 h-14 flex flex-col justify-center items-center border rounded-full border-foreground gap-1.5 pointer-events-auto backdrop-blur-sm'
            aria-label='Toggle menu'
         >
            <span
               class='hamburger-line w-8 h-0.5 bg-foreground transition-all duration-300 ease-in-out'
            ></span>
            <span
               class='hamburger-line w-8 h-0.5 bg-foreground transition-all duration-300 ease-in-out'
            ></span>
            <span
               class='hamburger-line w-8 h-0.5 bg-foreground transition-all duration-300 ease-in-out'
            ></span>
         </button>
      </div>
   </Container>
</nav>

<script>
   import { getI18N, defaultLang, type Language } from '@/i18n/utils';

   const menuToggle = document.getElementById("menu-toggle");
   const menuOverlay = document.getElementById("menu-overlay");
   const hamburgerLines = document.querySelectorAll(".hamburger-line");
   const logoMenu = document.querySelector(".logo-menu");
   const languageSwitcher = document.querySelector(".language-switcher");
   const menuItems = document.querySelectorAll(".menu-item");
   const langButtons = document.querySelectorAll(".lang-btn");

   let isMenuOpen = false;
   let currentLang: Language = (localStorage.getItem('lang') as Language) || defaultLang;

   // Función para actualizar textos
   function updateLanguage(lang: Language) {
      currentLang = lang;
      localStorage.setItem('lang', lang);

      const t = getI18N(lang);

      // Actualizar todos los elementos con data-i18n
      document.querySelectorAll('[data-i18n]').forEach((element) => {
         const key = element.getAttribute('data-i18n');
         if (key) {
            const keys = key.split('.');
            let value: any = t;
            for (const k of keys) {
               value = value[k];
            }
            if (value) {
               element.textContent = value;
            }
         }
      });

      // Actualizar placeholders
      document.querySelectorAll('[data-i18n-placeholder]').forEach((element) => {
         const key = element.getAttribute('data-i18n-placeholder');
         if (key) {
            const keys = key.split('.');
            let value: any = t;
            for (const k of keys) {
               value = value[k];
            }
            if (value && element instanceof HTMLInputElement || element instanceof HTMLTextAreaElement) {
               element.placeholder = value;
            }
         }
      });

      // Actualizar estado activo de los botones
      langButtons.forEach((btn) => {
         const btnLang = btn.getAttribute('data-lang');
         if (btnLang === lang) {
            btn.classList.add('bg-foreground/10');
            btn.classList.remove('hover:bg-foreground/5');
         } else {
            btn.classList.remove('bg-foreground/10');
            btn.classList.add('hover:bg-foreground/5');
         }
      });

      // Disparar evento personalizado para que otros componentes puedan reaccionar
      window.dispatchEvent(new CustomEvent('languageChanged', { detail: { lang } }));
   }

   // Inicializar idioma al cargar
   updateLanguage(currentLang);

   // Toggle menu
   menuToggle?.addEventListener("click", () => {
      isMenuOpen = !isMenuOpen;

      if (isMenuOpen) {
         // Abrir menú
         menuOverlay?.classList.remove("translate-x-full");
         menuOverlay?.classList.add("translate-x-0");
         menuOverlay?.classList.remove("pointer-events-none");
         menuOverlay?.classList.add("pointer-events-auto");

         // Mostrar logo, ocultar botones de idioma
         logoMenu?.classList.remove("opacity-0", "pointer-events-none");
         logoMenu?.classList.add("opacity-100", "pointer-events-auto");

         languageSwitcher?.classList.remove("opacity-100", "pointer-events-auto");
         languageSwitcher?.classList.add("opacity-0", "pointer-events-none");

         // Animar hamburger a X
         hamburgerLines[0]?.classList.add("rotate-45", "translate-y-2");
         hamburgerLines[1]?.classList.add("opacity-0");
         hamburgerLines[2]?.classList.add("-rotate-45", "-translate-y-2");
      } else {
         // Cerrar menú
         menuOverlay?.classList.add("translate-x-full");
         menuOverlay?.classList.remove("translate-x-0");
         menuOverlay?.classList.add("pointer-events-none");
         menuOverlay?.classList.remove("pointer-events-auto");

         // Ocultar logo, mostrar botones de idioma
         logoMenu?.classList.add("opacity-0", "pointer-events-none");
         logoMenu?.classList.remove("opacity-100", "pointer-events-auto");

         languageSwitcher?.classList.add("opacity-100", "pointer-events-auto");
         languageSwitcher?.classList.remove("opacity-0", "pointer-events-none");

         // Revertir hamburger
         hamburgerLines[0]?.classList.remove("rotate-45", "translate-y-2");
         hamburgerLines[1]?.classList.remove("opacity-0");
         hamburgerLines[2]?.classList.remove("-rotate-45", "-translate-y-2");
      }
   });

   // Cerrar menú al hacer click en items
   menuItems.forEach((item) => {
      item.addEventListener("click", () => {
         menuToggle?.click();
      });
   });

   // Cambiar idioma
   langButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
         const lang = btn.getAttribute("data-lang") as Language;
         if (lang && lang !== currentLang) {
            updateLanguage(lang);
         }
      });
   });
</script>
